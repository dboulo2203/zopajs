<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche de Stages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        <!--  :root {
        --primary-color: #8b4513;
        --primary-hover: #6d3710;
        }

        .bg-primary-custom {
            background-color: var(--primary-color) !important;
        }

        .text-primary-custom {
            color: var(--primary-color) !important;
        }

        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary-custom:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .border-primary-custom {
            border-color: var(--primary-color) !important;
        }
        -->
        .result-row
        {
        cursor:
        pointer;
        transition:
        background-color
        0.2s;
        }
        .result-row:hover
        {
        background-color:
        #f8f9fa;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Header -->

    <div class="container pb-4">
        <!-- Search Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <span class="card-title mb-4 fs-3">
                    <i class="bi bi-search"></i> Recherche de produit
                </span>
                <form id="searchForm">
                    <div class="row g-3">
                        <div class="col-md-9">
                            <input type="text" id="searchInput" class="form-control form-control-lg"
                                placeholder="Entrez votre recherche (titre, r√©f√©rence...)" autocomplete="off" required>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-secondary btn-lg w-100">
                                Rechercher
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-warning alert-dismissible fade show d-none" id="error" role="alert">
            <strong>Erreur!</strong> <span id="errorMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Loading Spinner -->
        <div class="card shadow-sm text-center py-5 d-none" id="loading">
            <div class="card-body">
                <div class="spinner-border text-secondary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Recherche en cours...</p>
            </div>
        </div>

        <!-- Results -->
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'https://www.kusala.fr/dolibarr/api/index.php/products';
        const API_KEY = 'OpK1D8otonWg690PIoj570KdHSCqCc04';

        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const loadingEl = document.getElementById('loading');
        const resultsEl = document.getElementById('results');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('errorMessage');

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const searchString = searchInput.value.trim();
            if (!searchString) return;

            // Reset UI
            loadingEl.classList.remove('d-none');
            resultsEl.classList.add('d-none');
            errorEl.classList.add('d-none');
            resultsEl.innerHTML = '';

            try {
                // Construct API URL
                const sqlFilters = `(t.label:like:'%25${encodeURIComponent(searchString)}%25') OR (t.ref:like:'%25${encodeURIComponent(searchString)}%25')`;
                const url = `${API_BASE_URL}?sqlfilters=${sqlFilters}&DOLAPIKEY=${API_KEY}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }

                const data = await response.json();

                loadingEl.classList.add('d-none');

                if (!data || data.length === 0) {
                    resultsEl.innerHTML = `
                        <div class="card shadow-sm">
                            <div class="card-body text-center py-5">
                                <h3 class="h5 mb-3">Aucun r√©sultat</h3>
                                <p class="text-muted">Aucun stage trouv√© pour "${searchString}"</p>
                            </div>
                        </div>
                    `;
                } else {
                    resultsEl.innerHTML = `
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <span class="fs-6 mb-0 text-primary-custom">
                                    üìã R√©sultats de la recherche (${data.length})
                                </span>
                            </div>
                            <div class="list-group list-group-flush">
                                ${data.map(stage => `
                                    <div class="list-group-item result-row" onclick="viewStageDetails(${stage.id})">
                                        <div class="d-flex  justify-content-between align-items-start">
                                            <div>
                                                <span class="fw-light">${stage.ref || 'N/A'}</span><br/>
                                                <span class="fs-5 mb-2">${stage.label || 'Sans titre'}</span>

                                                <div class="d-flex flex-wrap gap-3  text-muted">
                                                    <span class="fw-light">Date d√©but : </span>${new Intl.DateTimeFormat("fr-FR",
                        {
                            year: "numeric",
                            month: "numeric",
                            day: "numeric",
                            hour: "numeric",
                            minute: "numeric",
                        }).format(stage.array_options.options_sta_datedebut * 1000)
                        }
            <span class="fw-light">Prix : </span>
                            ${Object.values(stage.multiprices_ttc).map(element => new Intl.NumberFormat("fr-FR", {
                            style: "currency",
                            currency: "EUR",
                        }).format(element)).join(', ')
                        }}
                                                </div>
                                            </div>
                                            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="text-muted">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                resultsEl.classList.remove('d-none');

            } catch (error) {
                loadingEl.classList.add('d-none');
                errorMessageEl.textContent = `Erreur lors de la recherche: ${error.message}`;
                errorEl.classList.remove('d-none');
                console.error('Search error:', error);
            }
        });

        // Focus on input on page load
        searchInput.focus();

        // Navigate to stage details page
        function viewStageDetails(stageId) {
            window.location.href = `stage-detail.html?id=${stageId}`;
        }

        // // Get product type label
        // function getProductType(type) {
        //     const types = {
        //         '0': 'Produit',
        //         '1': 'Service',
        //         '2': 'Ensemble/Kit',
        //         '3': 'Mati√®re premi√®re'
        //     };
        //     return types[type] || `Type ${type}`;
        // }
    </script>
</body>

</html>